{% extends "home/base2.html" %}
{% load static %}
 {% block title %}cart{% endblock title %}
{% block content %}
{% load products_tag %}
<!-- breadcrumb-area -->
<section class="breadcrumb__area fix">
    <div class="container">
        <div class="row align-items-end">
            <div class="col-lg-8">
                <div class="breadcrumb__content">
                    <h3 class="title">Your Cart List</h3>
                    <nav class="breadcrumb">
                        <span property="itemListElement" typeof="ListItem">
                            <a href="{% url 'home' %}">Home</a>
                        </span>
                        <span class="breadcrumb-separator"><i class="flaticon-right-arrow-angle"></i></span>
                        <span property="itemListElement" typeof="ListItem">Cart</span>
                    </nav>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="breadcrumb__img">
                    <img src="{% static 'assets/img/images/breadcrumb_img.png' %}" alt="img" data-aos="fade-left" data-aos-delay="800">
                </div>
            </div>
        </div>
    </div>
    <div class="breadcrumb__shape-wrap">
        <img src="{% static 'assets/img/images/breadcrumb_shape01.png' %}" alt="img" data-aos="fade-down-right" data-aos-delay="400">
        <img src="{% static 'assets/img/images/breadcrumb_shape02.png' %}" alt="img" data-aos="fade-up-left" data-aos-delay="400">
    </div>
</section>
<!-- breadcrumb-area-end -->
<!-- ================cart-section start here================ -->
<div class="container mt-4" style="padding: 20px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
    <!-- Content -->    
    <div class="row">
        <div class="col-md-12">
            <h2>Shopping Cart</h2>
            <table class="table" style="width: 100%; margin-bottom: 1rem; color: #212529;">
                <thead>
                    <tr>
                        <th class="product-thumbnail" style="vertical-align: bottom; border-bottom: 2px solid #dee2e6;">Images</th>
                        <th class="cart-product-name" style="vertical-align: bottom; border-bottom: 8px solid #dee2e6;">Product</th>
                        <th class="product-price" style="vertical-align: bottom; border-bottom: 2px solid #dee2e6;">Unit Price</th>
                        <th class="product-quantity" style="vertical-align: bottom; border-bottom: 2px solid #dee2e6;">Quantity</th>
                        <th class="product-subtotal" style="vertical-align: bottom; border-bottom: 2px solid #dee2e6;">Total</th>
                        <th class="product-remove" style="vertical-align: bottom; border-bottom: 2px solid #dee2e6;">Remove</th>
                    </tr>
                </thead>
                <tbody>
                <form method="post" action="{% url "checkout" %}">
                    {% csrf_token %}
                    <!-- Loop through cart items and display each -->
                    {% for item in cart_items %}
                                <tr>
                                <td class="product-thumbnail" style="vertical-align: middle;">
                                    <a href="{% url 'product_details' item.product.slug %}">
                                        <img src="{{ item.product.featured_image }}" alt="{{ item.product.title }}" style="max-width: 100px; height: auto;">
                                    </a>
                                </td>
                                    <td class="product-name">
                                        <a href="{% url 'product_details' item.product.slug %}">{{ item.product.title|truncatechars:50 }}</a>
                                    </td>
                                    <td class="product-price">
                                            <span class="amount">{{ item.product.price|apply_discount:item.product.discount }}</span>
                                    </td>
                                    <td class="product-quantity">
                                        <div class="cart-plus-minus">
                                            <input type="text" value="{{ item.quantity }}" data-id="{{ item.id }}" class="qty-input">
                                            <div class="dec qtybutton"  data-id="{{ item.id }}">-</div>
                                            <div class="inc qtybutton"  data-id="{{ item.id }}">+</div>
                                        </div>
                                    </td>
                                    <td class="product-subtotal">
                                             <span class="amount">{{ item.product.price|multiply:item.quantity|apply_discount:item.product.discount }}</span>
                                    <td class="product-remove">
                                        <a href="#" class="remove-item" data-id="{{ item.id }}" data-csrf-token="{{ csrf_token }}"><i class="fa fa-trash"></i></a>
                                    </td>
                                </tr>
                        {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
            <div class="col-md-4">
            <h4>Cart Summary</h4>
            <ul class="list-group">
                
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Total Items
                        <span>{% display_quantity cart_items %} ITEMS</span>

                </li>
                
                

                
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Total Price
                    <span>â‚¹ {% calculate_total cart_items %}</span>
                </li>
            </ul>
            <div class="mt-3">
              
                <a href="{% url 'shop' %}" class="btn border-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="17" height="10" viewBox="0 0 17 10" fill="none">
  <path d="M6.18182 0.53137C6.18182 1.00948 5.68587 1.72343 5.18387 2.32268C4.53842 3.09591 3.76709 3.77055 2.88284 4.28539C2.21982 4.67136 1.41598 5.04186 0.76916 5.04186M0.76916 5.04186C1.41598 5.04186 2.22052 5.41236 2.88284 5.79833C3.76709 6.31382 4.53842 6.98846 5.18387 7.7604C5.68587 8.36029 6.18182 9.07553 6.18182 9.55235M0.76916 5.04186L17.0069 5.04186" stroke="currentcolor" stroke-width="1.8042"></path>
  <path d="M6.18182 0.53137C6.18182 1.00948 5.68587 1.72343 5.18387 2.32268C4.53842 3.09591 3.76709 3.77055 2.88284 4.28539C2.21982 4.67136 1.41598 5.04186 0.76916 5.04186M0.76916 5.04186C1.41598 5.04186 2.22052 5.41236 2.88284 5.79833C3.76709 6.31382 4.53842 6.98846 5.18387 7.7604C5.68587 8.36029 6.18182 9.07553 6.18182 9.55235M0.76916 5.04186L17.0069 5.04186" stroke="currentcolor" stroke-width="1.8042"></path>
</svg>  Back To Shop</a>
    <button type="submit" class=" btn tn btn-success btn-block">Proceed to Checkout</button>
            </div>
        </form>
        </div>
</div>

<br>
<br>
{% endblock content %}

{% block js %}
<!-- ===============cart section end here ==================-->
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Event listener for increment and decrement buttons
    document.querySelectorAll('.qtybutton').forEach(button => {
        button.addEventListener('click', function () {
            const input = this.parentElement.querySelector('input');
            let qty = parseInt(input.value, 10);
            if (this.classList.contains('dec')) {
                qty = Math.max(1, qty); // Decrease quantity
            } else {
                qty + 1; // Increase quantity
            }
            input.value = qty;

            // Send an AJAX request to update the quantity in the cart
            const itemId = input.dataset.id;
            const data = {
                quantity: qty
            };
            updateCartItem(itemId, data);
        });
    });

    // Event listener for remove buttons
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function (event) {
            event.preventDefault(); // Prevent following the link

            const itemId = this.dataset.id;
            const csrfToken = this.dataset.csrfToken;

            // Send an AJAX request to remove the item from the cart
            fetch(`/remove-from-cart/${itemId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ item_id: itemId })
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();  // Refresh the page after successful removal
                } else {
                    console.error('Failed to remove item from cart');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    });

    function updateCartItem(itemId, data) {
        fetch(`/update-cart-item/${itemId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' // Add CSRF token for security
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                console.error('Failed to update cart item');
            } else {
                window.location.reload(); // Refresh the page after a successful update
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
});
</script>
{% endblock js %} 

