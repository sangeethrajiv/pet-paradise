{% extends "home/base2.html" %}
{% load static %}
{% block title %}Adoption Request{% endblock title %}
{% block content %}
<section class="breadcrumb__area fix">
    <div class="container">
        <div class="row align-items-end">
            <div class="col-lg-8">
                <div class="breadcrumb__content">
                    <h3 class="title">Request Form</h3>
                    <nav class="breadcrumb">
                        <span property="itemListElement" typeof="ListItem">
                            <a href="{% url 'home' %}">Home</a> 
                        </span>
                        <span class="breadcrumb-separator"><i class="flaticon-right-arrow-angle"></i></span>
                        <span property="itemListElement" typeof="ListItem">
                          <a href="{% url 'petadoption' %}">Shop</a> 
                        </span>
                        <span class="breadcrumb-separator"><i class="flaticon-right-arrow-angle"></i></span>
                        <span property="itemListElement" typeof="ListItem">
                          <a href="{% url 'adoptionrequestsend' pet_id=pet.id %}">Request Page</a>
                        </span>
                    </nav>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="breadcrumb__img">
                    <img src="{% static 'assets/img/images/breadcrumb_img.png' %}" alt="img" data-aos="fade-left" data-aos-delay="800">
                </div>
            </div>
        </div>
    </div>
    <div class="breadcrumb__shape-wrap">
        <img src="{% static 'assets/img/images/breadcrumb_shape01.png' %}" alt="img" data-aos="fade-down-right" data-aos-delay="400">
        <img src="{% static 'assets/img/images/breadcrumb_shape02.png' %}" alt="img" data-aos="fade-up-left" data-aos-delay="400">
    </div>
</section>

{% if messages %}
    <div class="alert alert-danger text-center" role="alert">
        {% for message in messages %}
            <strong>{{ message }}</strong>
        {% endfor %}
    </div>
{% endif %}

<section class="registration__area-two">
    <div class="container">
        <div class="registration__inner-wrap-two">
            <div class="row">
                <div class="col-lg-8">
                    <div class="registration__form-wrap">
                        <form id="adoption-request-form" action="{% url 'adoptionrequestsend' pet.id %}" method="post" class="registration__form">
                            {% csrf_token %}
                            <h3 class="title">Request a Schedule</h3>
                            <span>Your email address will not be published. Required fields are marked *</span>
                            <div class="row gutter-20">
                                <div class="col-md-6">
                                    <div class="form-grp">
                                        <input type="text" value="{{ request.user.username }}" name="fullname" placeholder="FullName" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-grp">
                                        <input type="email" value="{{ request.user.email }}" name="email" placeholder="E-mail" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-grp">
                                        <input type="tel" name="phone" placeholder="Phone" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-grp">
                                        <input type="date" name="appointment_date" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-grp select-grp">
                                        <select name="species" class="orderby" required>
                                            <option value="{{ pet.species }}">{{ pet.species }}</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-grp select-grp">
                                        <select name="breeds" class="orderby">
                                             <option value="{{ pet.breed }}">{{ pet.breed }}</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-grp select-grp">
                                        <select id="pet_id" name="pet_id" class="orderby">
                                            <option value="{{ pet.id }}" selected>{{ pet.name }}</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-grp">
                                        <textarea name="comment" placeholder="Special Note . . ."></textarea>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn">Book Now <img src="{% static 'assets/img/icon/right_arrow.svg' %}" alt="" class="injectable"></button>
                        </form>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="registration__img">
                        <img src="{% static 'assets/img/images/registration_img.png' %}" alt="" data-aos="fade-right" data-aos-delay="400">
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('adoption-request-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        console.log('FormData:', [...formData.entries()]); // Log form data

        fetch(this.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams(formData).toString()
        })
        .then(response => {
            console.log('Response Status:', response.status); // Log response status
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Response Data:', data); // Log response data
            if (data.success) {
                Swal.fire({
                    title: "Adoption Request Submitted!",
                    text: "Thank you, our team members will contact you soon!",
                    icon: "success"
                }).then(() => {
                    window.location.href = data.redirect_url;
                });
            } else {
                Swal.fire({
                    title: "Error",
                    text: "Please correct the errors below.",
                    icon: "error"
                });
                Object.keys(data.errors || {}).forEach(field => {
                    const errorMessages = data.errors[field].map(error => error.message).join(', ');
                    const fieldElement = document.querySelector(`[name="${field}"]`);
                    if (fieldElement) {
                        fieldElement.setCustomValidity(errorMessages);
                        fieldElement.reportValidity();
                    }
                });
            }
        })
        .catch(error => {
            Swal.fire({
                title: "Unexpected Error",
                text: "An unexpected error occurred. Please try again later.",
                icon: "error"
            });
            console.error('Error:', error);
        });
    });
});

</script>

{% endblock content %}
